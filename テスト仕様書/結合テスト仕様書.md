# FastAPI 議事録生成アプリ 結合テスト仕様書

## 1. テスト概要

### 1.1 テスト目的
FastAPIを使用した議事録生成アプリケーションのAPIエンドポイント間の連携および統合機能の品質保証を行う。
複数のモジュールが連携して正しく動作することを確認し、インターフェース間の不具合を検出する。

### 1.2 テスト対象
- 認証APIエンドポイント（登録、ログイン、認証保護）
- 議事録生成APIエンドポイント（生成、認証連携）
- アプリケーション全体のエンドポイント統合
- API間のデータフロー

### 1.3 テスト環境
- **テストフレームワーク**: pytest
- **HTTPクライアント**: FastAPI TestClient
- **モック**: unittest.mock
- **カバレッジ**: pytest-cov
- **Python バージョン**: 3.8+

### 1.4 テスト戦略
- **API統合**: エンドポイント間の連携テスト
- **認証フロー**: 認証が必要なAPIの統合テスト
- **データフロー**: リクエスト・レスポンスの整合性確認
- **エラー連携**: エラー処理の統合確認

## 2. テスト環境セットアップ

### 2.1 テスト用依存関係
```txt
# requirements-test.txt
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
httpx==0.25.2
pytest-mock==3.12.0
```

### 2.2 テスト設定ファイル
```python
# conftest.py
import pytest
from fastapi.testclient import TestClient
from src.main import app
from src.modules.user_store import user_store

@pytest.fixture
def client():
    return TestClient(app)

@pytest.fixture
def clean_user_store():
    user_store.clear_all_users()
    yield
    user_store.clear_all_users()

@pytest.fixture
def test_user_data():
    return {
        "username": "testuser",
        "email": "test@example.com",
        "password": "testpassword123"
    }

@pytest.fixture
def authenticated_headers(client, test_user_data, clean_user_store):
    # ユーザー登録
    client.post("/api/v1/auth/register", json=test_user_data)
    
    # ログイン
    login_data = {
        "username": test_user_data["username"],
        "password": test_user_data["password"]
    }
    response = client.post("/api/v1/auth/login", data=login_data)
    token = response.json()["access_token"]
    
    return {"Authorization": f"Bearer {token}"}
```

## 3. 認証API結合テスト

### 3.1 ユーザー登録APIテスト (test_auth_api.py)

#### 3.1.1 ユーザー登録成功テスト
```python
def test_register_user_success(client, clean_user_store):
    """ユーザー登録成功テスト"""
    user_data = {
        "username": "newuser",
        "email": "newuser@example.com",
        "password": "newpassword123"
    }
    
    response = client.post("/api/v1/auth/register", json=user_data)
    
    assert response.status_code == 200
    data = response.json()
    assert data["username"] == user_data["username"]
    assert data["email"] == user_data["email"]
    assert "id" in data
    assert "created_at" in data

def test_register_duplicate_username(client, clean_user_store):
    """重複ユーザー名登録テスト"""
    user_data = {
        "username": "testuser",
        "email": "test1@example.com",
        "password": "password123"
    }
    
    # 最初の登録
    client.post("/api/v1/auth/register", json=user_data)
    
    # 重複ユーザー名で再登録
    duplicate_data = {
        "username": "testuser",
        "email": "test2@example.com",
        "password": "password456"
    }
    
    response = client.post("/api/v1/auth/register", json=duplicate_data)
    
    assert response.status_code == 400
    assert "Username already registered" in response.json()["detail"]

def test_register_duplicate_email(client, clean_user_store):
    """重複メールアドレス登録テスト"""
    user_data = {
        "username": "testuser1",
        "email": "test@example.com",
        "password": "password123"
    }
    
    # 最初の登録
    client.post("/api/v1/auth/register", json=user_data)
    
    # 重複メールアドレスで再登録
    duplicate_data = {
        "username": "testuser2",
        "email": "test@example.com",
        "password": "password456"
    }
    
    response = client.post("/api/v1/auth/register", json=duplicate_data)
    
    assert response.status_code == 400
    assert "Email already registered" in response.json()["detail"]

def test_register_invalid_email(client, clean_user_store):
    """無効なメールアドレス登録テスト"""
    user_data = {
        "username": "testuser",
        "email": "invalid-email",
        "password": "password123"
    }
    
    response = client.post("/api/v1/auth/register", json=user_data)
    
    assert response.status_code == 422
```

#### 3.1.2 ログインAPIテスト
```python
def test_login_success(client, test_user_data, clean_user_store):
    """ログイン成功テスト"""
    # ユーザー登録
    client.post("/api/v1/auth/register", json=test_user_data)
    
    # ログイン
    login_data = {
        "username": test_user_data["username"],
        "password": test_user_data["password"]
    }
    
    response = client.post("/api/v1/auth/login", data=login_data)
    
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert data["token_type"] == "bearer"

def test_login_invalid_username(client, clean_user_store):
    """無効なユーザー名でのログインテスト"""
    login_data = {
        "username": "nonexistent",
        "password": "password123"
    }
    
    response = client.post("/api/v1/auth/login", data=login_data)
    
    assert response.status_code == 401
    assert "Incorrect username or password" in response.json()["detail"]

def test_login_invalid_password(client, test_user_data, clean_user_store):
    """無効なパスワードでのログインテスト"""
    # ユーザー登録
    client.post("/api/v1/auth/register", json=test_user_data)
    
    # 間違ったパスワードでログイン
    login_data = {
        "username": test_user_data["username"],
        "password": "wrongpassword"
    }
    
    response = client.post("/api/v1/auth/login", data=login_data)
    
    assert response.status_code == 401
    assert "Incorrect username or password" in response.json()["detail"]
```

#### 3.1.3 認証保護エンドポイントテスト
```python
def test_get_current_user_success(client, authenticated_headers):
    """現在のユーザー情報取得成功テスト"""
    response = client.get("/api/v1/auth/me", headers=authenticated_headers)
    
    assert response.status_code == 200
    data = response.json()
    assert "username" in data
    assert "email" in data
    assert "id" in data

def test_get_current_user_no_token(client):
    """トークンなしでの現在ユーザー情報取得テスト"""
    response = client.get("/api/v1/auth/me")
    
    assert response.status_code == 401

def test_get_current_user_invalid_token(client):
    """無効なトークンでの現在ユーザー情報取得テスト"""
    headers = {"Authorization": "Bearer invalid_token"}
    response = client.get("/api/v1/auth/me", headers=headers)
    
    assert response.status_code == 401

def test_logout_success(client, authenticated_headers):
    """ログアウト成功テスト"""
    response = client.post("/api/v1/auth/logout", headers=authenticated_headers)
    
    assert response.status_code == 200
    assert "Successfully logged out" in response.json()["message"]
```

### 3.2 議事録生成API結合テスト (test_minutes_api.py)

#### 3.2.1 議事録生成APIテスト
```python
from unittest.mock import Mock, patch

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_generate_minutes_success(mock_azure_openai, client, authenticated_headers):
    """議事録生成成功テスト"""
    # モックレスポンス設定
    mock_response = Mock()
    mock_response.choices[0].message.content = '''
    {
        "meeting_title": "Weekly Team Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob", "Charlie"],
        "summary": "Discussed project progress and next steps",
        "key_points": ["Project is on track", "Need to review requirements"],
        "action_items": ["Alice to update documentation", "Bob to review code"],
        "next_meeting": "2024-01-22T10:00:00"
    }
    '''
    mock_azure_openai.return_value.chat.completions.create.return_value = mock_response
    
    # テストデータ
    transcript_data = {
        "meeting_title": "Weekly Team Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob", "Charlie"],
        "transcript_text": "Alice: Good morning everyone. Let's start with the project update...",
        "additional_notes": "Meeting held via video conference"
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 200
    data = response.json()
    assert "meeting_title" in data
    assert "summary" in data
    assert "key_points" in data
    assert "action_items" in data

def test_generate_minutes_no_auth(client):
    """認証なしでの議事録生成テスト"""
    transcript_data = {
        "meeting_title": "Weekly Team Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob", "Charlie"],
        "transcript_text": "Alice: Good morning everyone...",
    }
    
    response = client.post("/api/v1/minutes/generate", json=transcript_data)
    
    assert response.status_code == 401

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_generate_minutes_invalid_token(mock_azure_openai, client):
    """無効なトークンでの議事録生成テスト"""
    transcript_data = {
        "meeting_title": "Weekly Team Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob", "Charlie"],
        "transcript_text": "Alice: Good morning everyone...",
    }
    
    headers = {"Authorization": "Bearer invalid_token"}
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=headers
    )
    
    assert response.status_code == 401

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_generate_minutes_azure_openai_error(mock_azure_openai, client, authenticated_headers):
    """Azure OpenAI APIエラー時の議事録生成テスト"""
    # Azure OpenAI APIエラーをシミュレート
    mock_azure_openai.return_value.chat.completions.create.side_effect = Exception("API Error")
    
    transcript_data = {
        "meeting_title": "Weekly Team Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob", "Charlie"],
        "transcript_text": "Alice: Good morning everyone...",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 500
    assert "Failed to generate meeting minutes" in response.json()["detail"]

def test_generate_minutes_invalid_data(client, authenticated_headers):
    """無効なデータでの議事録生成テスト"""
    invalid_data = {
        "meeting_title": "",  # 空のタイトル
        "meeting_date": "invalid-date",  # 無効な日付
        "participants": [],  # 空の参加者リスト
        "transcript_text": "",  # 空のトランスクリプト
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=invalid_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 422
```

### 3.3 アプリケーション全体結合テスト (test_main.py)

#### 3.3.1 基本エンドポイントテスト
```python
def test_root_endpoint(client):
    """ルートエンドポイントテスト"""
    response = client.get("/")
    
    assert response.status_code == 200
    data = response.json()
    assert "message" in data
    assert "status" in data
    assert "version" in data
    assert data["status"] == "running"

def test_health_check_endpoint(client):
    """ヘルスチェックエンドポイントテスト"""
    response = client.get("/health")
    
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "healthy"
    assert data["service"] == "meeting-minutes-generator"
```

#### 3.3.2 認証フロー統合テスト
```python
def test_full_authentication_flow(client, clean_user_store):
    """完全な認証フロー統合テスト"""
    # 1. ユーザー登録
    user_data = {
        "username": "flowtest",
        "email": "flowtest@example.com",
        "password": "flowpassword123"
    }
    
    register_response = client.post("/api/v1/auth/register", json=user_data)
    assert register_response.status_code == 200
    
    # 2. ログイン
    login_data = {
        "username": user_data["username"],
        "password": user_data["password"]
    }
    
    login_response = client.post("/api/v1/auth/login", data=login_data)
    assert login_response.status_code == 200
    token = login_response.json()["access_token"]
    
    # 3. 認証が必要なエンドポイントにアクセス
    headers = {"Authorization": f"Bearer {token}"}
    me_response = client.get("/api/v1/auth/me", headers=headers)
    assert me_response.status_code == 200
    assert me_response.json()["username"] == user_data["username"]
    
    # 4. ログアウト
    logout_response = client.post("/api/v1/auth/logout", headers=headers)
    assert logout_response.status_code == 200

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_full_minutes_generation_flow(mock_azure_openai, client, clean_user_store):
    """完全な議事録生成フロー統合テスト"""
    # モックレスポンス設定
    mock_response = Mock()
    mock_response.choices[0].message.content = "Generated meeting minutes"
    mock_azure_openai.return_value.chat.completions.create.return_value = mock_response
    
    # 1. ユーザー登録
    user_data = {
        "username": "minutesuser",
        "email": "minutesuser@example.com",
        "password": "minutespassword123"
    }
    client.post("/api/v1/auth/register", json=user_data)
    
    # 2. ログイン
    login_data = {
        "username": user_data["username"],
        "password": user_data["password"]
    }
    login_response = client.post("/api/v1/auth/login", data=login_data)
    token = login_response.json()["access_token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # 3. 議事録生成
    transcript_data = {
        "meeting_title": "Integration Test Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob"],
        "transcript_text": "Alice: Let's discuss the integration test...",
    }
    
    minutes_response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=headers
    )
    
    assert minutes_response.status_code == 200
    assert "Generated meeting minutes" in minutes_response.text
```

## 4. テスト実行手順

### 4.1 結合テスト実行コマンド
```bash
# 全結合テスト実行
pytest tests/test_auth_api.py tests/test_minutes_api.py tests/test_main.py

# カバレッジ付き結合テスト実行
pytest --cov=src --cov-report=html tests/test_auth_api.py tests/test_minutes_api.py tests/test_main.py

# 特定のAPIテスト実行
pytest tests/test_auth_api.py

# 認証フロー統合テスト実行
pytest tests/test_main.py::test_full_authentication_flow

# 詳細出力付きテスト実行
pytest -v tests/test_minutes_api.py
```

### 4.2 テスト結果の確認
```bash
# HTMLカバレッジレポート確認
open htmlcov/index.html

# テスト結果ログ確認
pytest --tb=short tests/test_auth_api.py  # 短縮トレースバック
pytest --tb=long tests/test_auth_api.py   # 詳細トレースバック
```

## 5. 品質指標

### 5.1 カバレッジ目標
- **API統合カバレッジ**: 90%以上
- **エンドポイントカバレッジ**: 100%
- **認証フローカバレッジ**: 95%以上

### 5.2 パフォーマンス指標
- **API レスポンス時間**: 95%のリクエストが3秒以内
- **認証処理時間**: 1秒以内
- **議事録生成時間**: 10秒以内（モック使用時）

## 6. 参考資料

- [FastAPI Testing Documentation](https://fastapi.tiangolo.com/tutorial/testing/)
- [TestClient Documentation](https://fastapi.tiangolo.com/tutorial/testing/#using-testclient)
- [pytest Documentation](https://docs.pytest.org/)
- [HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
