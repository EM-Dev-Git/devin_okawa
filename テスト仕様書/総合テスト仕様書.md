# FastAPI è­°äº‹éŒ²ç”Ÿæˆã‚¢ãƒ—ãƒª ç·åˆãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸

## 1. ãƒ†ã‚¹ãƒˆæ¦‚è¦

### 1.1 ãƒ†ã‚¹ãƒˆç›®çš„
FastAPIã‚’ä½¿ç”¨ã—ãŸè­°äº‹éŒ²ç”Ÿæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å“è³ªä¿è¨¼ã‚’è¡Œã†ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€é‹ç”¨é¢ã§ã®è¦ä»¶ã‚’æº€ãŸã™ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

### 1.2 ãƒ†ã‚¹ãƒˆå¯¾è±¡
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ï¼ˆèªè¨¼ã€èªå¯ã€å…¥åŠ›å€¤æ¤œè¨¼ï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆè² è·ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆä¾‹å¤–å‡¦ç†ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çµ±åˆå‹•ä½œ
- é‹ç”¨ãƒ»ä¿å®ˆæ€§

### 1.3 ãƒ†ã‚¹ãƒˆç’°å¢ƒ
- **ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: pytest
- **HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: FastAPI TestClient
- **è² è·ãƒ†ã‚¹ãƒˆ**: concurrent.futures
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ**: å„ç¨®æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
- **Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.8+

### 1.4 ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: è„†å¼±æ€§ã®å¾¹åº•çš„ãªæ¤œè¨¼
- **å®Ÿé‹ç”¨æƒ³å®š**: æœ¬ç•ªç’°å¢ƒã«è¿‘ã„æ¡ä»¶ã§ã®ãƒ†ã‚¹ãƒˆ
- **å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ**: ã‚·ã‚¹ãƒ†ãƒ é™ç•Œã§ã®å‹•ä½œç¢ºèª
- **éšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: å„ç¨®ã‚¨ãƒ©ãƒ¼æ¡ä»¶ã§ã®å‹•ä½œç¢ºèª

## 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆä»•æ§˜

### 2.1 èªè¨¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ (test_security.py)

#### 2.1.1 JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
```python
import jwt
from datetime import datetime, timedelta
from src.config import settings

def test_expired_token(client, test_user_data, clean_user_store):
    """æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ"""
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    client.post("/api/v1/auth/register", json=test_user_data)
    
    # æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰‹å‹•ä½œæˆ
    expired_payload = {
        "sub": test_user_data["username"],
        "exp": datetime.utcnow() - timedelta(minutes=1)  # 1åˆ†å‰ã«æœŸé™åˆ‡ã‚Œ
    }
    expired_token = jwt.encode(expired_payload, settings.jwt_secret_key, algorithm=settings.jwt_algorithm)
    
    headers = {"Authorization": f"Bearer {expired_token}"}
    response = client.get("/api/v1/auth/me", headers=headers)
    
    assert response.status_code == 401

def test_malformed_token(client):
    """ä¸æ­£ãªå½¢å¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ"""
    headers = {"Authorization": "Bearer malformed.token"}
    response = client.get("/api/v1/auth/me", headers=headers)
    
    assert response.status_code == 401

def test_missing_bearer_prefix(client, authenticated_headers):
    """Bearerãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ¬ å¦‚ãƒ†ã‚¹ãƒˆ"""
    token = authenticated_headers["Authorization"].replace("Bearer ", "")
    headers = {"Authorization": token}
    response = client.get("/api/v1/auth/me", headers=headers)
    
    assert response.status_code == 401

def test_token_with_wrong_secret(client, test_user_data, clean_user_store):
    """é–“é•ã£ãŸç§˜å¯†éµã§ä½œæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ"""
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    client.post("/api/v1/auth/register", json=test_user_data)
    
    # é–“é•ã£ãŸç§˜å¯†éµã§ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆ
    wrong_payload = {"sub": test_user_data["username"]}
    wrong_token = jwt.encode(wrong_payload, "wrong_secret_key", algorithm=settings.jwt_algorithm)
    
    headers = {"Authorization": f"Bearer {wrong_token}"}
    response = client.get("/api/v1/auth/me", headers=headers)
    
    assert response.status_code == 401

def test_token_algorithm_confusion(client, test_user_data, clean_user_store):
    """ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ··åŒæ”»æ’ƒãƒ†ã‚¹ãƒˆ"""
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    client.post("/api/v1/auth/register", json=test_user_data)
    
    # ç•°ãªã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆ
    payload = {"sub": test_user_data["username"]}
    wrong_algorithm_token = jwt.encode(payload, settings.jwt_secret_key, algorithm="HS512")
    
    headers = {"Authorization": f"Bearer {wrong_algorithm_token}"}
    response = client.get("/api/v1/auth/me", headers=headers)
    
    assert response.status_code == 401
```

#### 2.1.2 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
```python
def test_password_strength_validation(client, clean_user_store):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦æ¤œè¨¼ãƒ†ã‚¹ãƒˆ"""
    weak_passwords = [
        "123",
        "password",
        "abc",
        ""
    ]
    
    for weak_password in weak_passwords:
        user_data = {
            "username": f"user_{weak_password}",
            "email": f"user_{weak_password}@example.com",
            "password": weak_password
        }
        
        response = client.post("/api/v1/auth/register", json=user_data)
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯400ã€ãã†ã§ãªã‘ã‚Œã°200
        assert response.status_code in [200, 400, 422]

def test_password_hashing_uniqueness():
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã®ä¸€æ„æ€§ãƒ†ã‚¹ãƒˆ"""
    from src.modules.auth import get_password_hash
    
    password = "testpassword123"
    hash1 = get_password_hash(password)
    hash2 = get_password_hash(password)
    
    # bcryptã¯åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚ç•°ãªã‚‹ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã™ã‚‹
    assert hash1 != hash2
    
    # ã—ã‹ã—ä¸¡æ–¹ã¨ã‚‚å…ƒã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æ¤œè¨¼ã§ãã‚‹
    from src.modules.auth import verify_password
    assert verify_password(password, hash1) is True
    assert verify_password(password, hash2) is True

def test_brute_force_protection(client, clean_user_store):
    """ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒä¿è­·ãƒ†ã‚¹ãƒˆ"""
    # ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    user_data = {
        "username": "brutetest",
        "email": "brutetest@example.com",
        "password": "correctpassword123"
    }
    client.post("/api/v1/auth/register", json=user_data)
    
    # è¤‡æ•°å›ã®å¤±æ•—ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ
    for i in range(10):
        login_data = {
            "username": "brutetest",
            "password": f"wrongpassword{i}"
        }
        response = client.post("/api/v1/auth/login", data=login_data)
        assert response.status_code == 401
    
    # æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒãªã„å ´åˆï¼‰
    correct_login_data = {
        "username": "brutetest",
        "password": "correctpassword123"
    }
    response = client.post("/api/v1/auth/login", data=correct_login_data)
    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯429ã€ãã†ã§ãªã‘ã‚Œã°200
    assert response.status_code in [200, 429]
```

### 2.2 å…¥åŠ›å€¤æ¤œè¨¼ãƒ†ã‚¹ãƒˆ (test_input_validation.py)

#### 2.2.1 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ãƒ†ã‚¹ãƒˆ
```python
def test_sql_injection_attempts(client, clean_user_store):
    """SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒãƒ†ã‚¹ãƒˆ"""
    malicious_inputs = [
        "'; DROP TABLE users; --",
        "admin'--",
        "' OR '1'='1",
        "1' UNION SELECT * FROM users--"
    ]
    
    for malicious_input in malicious_inputs:
        user_data = {
            "username": malicious_input,
            "email": "test@example.com",
            "password": "password123"
        }
        
        response = client.post("/api/v1/auth/register", json=user_data)
        # é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ã¾ãŸã¯æ­£å¸¸å‡¦ç†ï¼‰
        assert response.status_code in [200, 400, 422]

def test_xss_prevention(client, authenticated_headers):
    """XSSæ”»æ’ƒé˜²æ­¢ãƒ†ã‚¹ãƒˆ"""
    malicious_script = "<script>alert('XSS')</script>"
    
    transcript_data = {
        "meeting_title": malicious_script,
        "meeting_date": "2024-01-15T10:00:00",
        "participants": [malicious_script],
        "transcript_text": f"Meeting content with {malicious_script}",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
    if response.status_code == 200:
        response_text = response.text
        assert "<script>" not in response_text
        assert "alert(" not in response_text

def test_command_injection_prevention(client, authenticated_headers):
    """ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢ãƒ†ã‚¹ãƒˆ"""
    malicious_commands = [
        "; rm -rf /",
        "| cat /etc/passwd",
        "&& curl malicious-site.com",
        "`whoami`"
    ]
    
    for malicious_command in malicious_commands:
        transcript_data = {
            "meeting_title": f"Meeting {malicious_command}",
            "meeting_date": "2024-01-15T10:00:00",
            "participants": ["Alice"],
            "transcript_text": f"Content {malicious_command}",
        }
        
        response = client.post(
            "/api/v1/minutes/generate",
            json=transcript_data,
            headers=authenticated_headers
        )
        
        # é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        assert response.status_code in [200, 400, 422, 500]

def test_path_traversal_prevention(client):
    """ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒé˜²æ­¢ãƒ†ã‚¹ãƒˆ"""
    malicious_paths = [
        "../../../etc/passwd",
        "..\\..\\..\\windows\\system32\\config\\sam",
        "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"
    ]
    
    for malicious_path in malicious_paths:
        response = client.get(f"/{malicious_path}")
        # 404ã¾ãŸã¯é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
        assert response.status_code in [404, 400, 403]
```

#### 2.2.2 å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ†ã‚¹ãƒˆ
```python
def test_large_transcript_handling(client, authenticated_headers):
    """å¤§å®¹é‡ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‡¦ç†ãƒ†ã‚¹ãƒˆ"""
    # å¤§å®¹é‡ã®ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆ1MBç¨‹åº¦ï¼‰
    large_transcript = "A" * (1024 * 1024)
    
    transcript_data = {
        "meeting_title": "Large Data Test",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice"],
        "transcript_text": large_transcript,
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    # é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆæˆåŠŸã¾ãŸã¯ã‚µã‚¤ã‚ºåˆ¶é™ã‚¨ãƒ©ãƒ¼ï¼‰
    assert response.status_code in [200, 413, 422]

def test_unicode_handling(client, authenticated_headers):
    """Unicodeæ–‡å­—å‡¦ç†ãƒ†ã‚¹ãƒˆ"""
    unicode_data = {
        "meeting_title": "ä¼šè­°ã‚¿ã‚¤ãƒˆãƒ« ğŸš€ Ã©mojis Ã± ä¸­æ–‡",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["ã‚¢ãƒªã‚¹", "ãƒœãƒ–", "JosÃ©"],
        "transcript_text": "ä¼šè­°å†…å®¹ã§ã™ã€‚çµµæ–‡å­— ğŸ‰ ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=unicode_data,
        headers=authenticated_headers
    )
    
    # Unicodeæ–‡å­—ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    assert response.status_code in [200, 500]  # 500ã¯Azure OpenAI APIã‚¨ãƒ©ãƒ¼ã®å ´åˆ
```

## 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆä»•æ§˜

### 3.1 è² è·ãƒ†ã‚¹ãƒˆ (test_performance.py)

#### 3.1.1 åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ
```python
import asyncio
import time
from concurrent.futures import ThreadPoolExecutor

def test_concurrent_user_registration(client, clean_user_store):
    """åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ†ã‚¹ãƒˆ"""
    def register_user(user_id):
        user_data = {
            "username": f"user_{user_id}",
            "email": f"user_{user_id}@example.com",
            "password": "password123"
        }
        return client.post("/api/v1/auth/register", json=user_data)
    
    # 10äººã®åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = [executor.submit(register_user, i) for i in range(10)]
        results = [future.result() for future in futures]
    
    # ã™ã¹ã¦ã®ç™»éŒ²ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    success_count = sum(1 for result in results if result.status_code == 200)
    assert success_count == 10

def test_concurrent_login_attempts(client, clean_user_store):
    """åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œãƒ†ã‚¹ãƒˆ"""
    # ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    user_data = {
        "username": "testuser",
        "email": "test@example.com",
        "password": "password123"
    }
    client.post("/api/v1/auth/register", json=user_data)
    
    def login_user():
        login_data = {
            "username": "testuser",
            "password": "password123"
        }
        return client.post("/api/v1/auth/login", data=login_data)
    
    # 5å›ã®åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³
    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = [executor.submit(login_user) for _ in range(5)]
        results = [future.result() for future in futures]
    
    # ã™ã¹ã¦ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    success_count = sum(1 for result in results if result.status_code == 200)
    assert success_count == 5

def test_concurrent_minutes_generation(client, clean_user_store):
    """åŒæ™‚è­°äº‹éŒ²ç”Ÿæˆãƒ†ã‚¹ãƒˆ"""
    # è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    users = []
    for i in range(5):
        user_data = {
            "username": f"minutesuser_{i}",
            "email": f"minutesuser_{i}@example.com",
            "password": "password123"
        }
        client.post("/api/v1/auth/register", json=user_data)
        
        # ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
        login_response = client.post("/api/v1/auth/login", data={
            "username": user_data["username"],
            "password": user_data["password"]
        })
        token = login_response.json()["access_token"]
        users.append({"Authorization": f"Bearer {token}"})
    
    def generate_minutes(headers):
        transcript_data = {
            "meeting_title": "Concurrent Test Meeting",
            "meeting_date": "2024-01-15T10:00:00",
            "participants": ["Alice", "Bob"],
            "transcript_text": "Short transcript for concurrent testing",
        }
        return client.post("/api/v1/minutes/generate", json=transcript_data, headers=headers)
    
    # 5ã¤ã®åŒæ™‚è­°äº‹éŒ²ç”Ÿæˆ
    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = [executor.submit(generate_minutes, user_headers) for user_headers in users]
        results = [future.result() for future in futures]
    
    # çµæœã®ç¢ºèªï¼ˆæˆåŠŸã¾ãŸã¯APIã‚¨ãƒ©ãƒ¼ï¼‰
    for result in results:
        assert result.status_code in [200, 500]  # 500ã¯Azure OpenAI APIã‚¨ãƒ©ãƒ¼ã®å ´åˆ
```

#### 3.1.2 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãƒ†ã‚¹ãƒˆ
```python
from unittest.mock import Mock, patch

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_minutes_generation_response_time(mock_azure_openai, client, authenticated_headers):
    """è­°äº‹éŒ²ç”Ÿæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãƒ†ã‚¹ãƒˆ"""
    # ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­å®š
    mock_response = Mock()
    mock_response.choices[0].message.content = "Generated minutes"
    mock_azure_openai.return_value.chat.completions.create.return_value = mock_response
    
    transcript_data = {
        "meeting_title": "Performance Test Meeting",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice", "Bob"],
        "transcript_text": "Short transcript for performance testing",
    }
    
    start_time = time.time()
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    end_time = time.time()
    
    response_time = end_time - start_time
    
    assert response.status_code == 200
    assert response_time < 5.0  # 5ç§’ä»¥å†…ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹

def test_authentication_response_time(client, test_user_data, clean_user_store):
    """èªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãƒ†ã‚¹ãƒˆ"""
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    client.post("/api/v1/auth/register", json=test_user_data)
    
    login_data = {
        "username": test_user_data["username"],
        "password": test_user_data["password"]
    }
    
    start_time = time.time()
    response = client.post("/api/v1/auth/login", data=login_data)
    end_time = time.time()
    
    response_time = end_time - start_time
    
    assert response.status_code == 200
    assert response_time < 1.0  # 1ç§’ä»¥å†…ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹

def test_endpoint_response_times(client):
    """å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãƒ†ã‚¹ãƒˆ"""
    endpoints = [
        ("/", "GET"),
        ("/health", "GET"),
    ]
    
    for endpoint, method in endpoints:
        start_time = time.time()
        if method == "GET":
            response = client.get(endpoint)
        end_time = time.time()
        
        response_time = end_time - start_time
        
        assert response.status_code == 200
        assert response_time < 1.0  # 1ç§’ä»¥å†…ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

### 3.2 ãƒ¡ãƒ¢ãƒªãƒ»ãƒªã‚½ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
```python
import psutil
import os

def test_memory_usage_during_minutes_generation(client, authenticated_headers):
    """è­°äº‹éŒ²ç”Ÿæˆæ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆ"""
    process = psutil.Process(os.getpid())
    initial_memory = process.memory_info().rss / 1024 / 1024  # MB
    
    # è¤‡æ•°å›ã®è­°äº‹éŒ²ç”Ÿæˆ
    for i in range(10):
        transcript_data = {
            "meeting_title": f"Memory Test Meeting {i}",
            "meeting_date": "2024-01-15T10:00:00",
            "participants": ["Alice", "Bob"],
            "transcript_text": f"Test transcript {i} " * 100,  # é©åº¦ãªã‚µã‚¤ã‚º
        }
        
        response = client.post(
            "/api/v1/minutes/generate",
            json=transcript_data,
            headers=authenticated_headers
        )
    
    final_memory = process.memory_info().rss / 1024 / 1024  # MB
    memory_increase = final_memory - initial_memory
    
    # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¢—åŠ ãŒè¨±å®¹ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert memory_increase < 100  # 100MBä»¥ä¸‹ã®å¢—åŠ 
```

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆä»•æ§˜

### 4.1 ä¾‹å¤–å‡¦ç†ãƒ†ã‚¹ãƒˆ (test_error_handling.py)

#### 4.1.1 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ
```python
@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_azure_openai_network_error(mock_azure_openai, client, authenticated_headers):
    """Azure OpenAI ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ"""
    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    mock_azure_openai.return_value.chat.completions.create.side_effect = ConnectionError("Network error")
    
    transcript_data = {
        "meeting_title": "Network Error Test",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice"],
        "transcript_text": "Test transcript",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 500
    assert "Failed to generate meeting minutes" in response.json()["detail"]

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_azure_openai_timeout_error(mock_azure_openai, client, authenticated_headers):
    """Azure OpenAI ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ"""
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    mock_azure_openai.return_value.chat.completions.create.side_effect = TimeoutError("Request timeout")
    
    transcript_data = {
        "meeting_title": "Timeout Error Test",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice"],
        "transcript_text": "Test transcript",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 500

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_azure_openai_rate_limit_error(mock_azure_openai, client, authenticated_headers):
    """Azure OpenAI ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ"""
    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    from openai import RateLimitError
    mock_azure_openai.return_value.chat.completions.create.side_effect = RateLimitError("Rate limit exceeded")
    
    transcript_data = {
        "meeting_title": "Rate Limit Test",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": ["Alice"],
        "transcript_text": "Test transcript",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=transcript_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 429  # Too Many Requests
```

#### 4.1.2 ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ
```python
def test_invalid_json_format(client, authenticated_headers):
    """ç„¡åŠ¹ãªJSONå½¢å¼ãƒ†ã‚¹ãƒˆ"""
    # ç„¡åŠ¹ãªJSONãƒ‡ãƒ¼ã‚¿
    invalid_json = '{"meeting_title": "Test", "invalid_json"}'
    
    response = client.post(
        "/api/v1/minutes/generate",
        data=invalid_json,
        headers={**authenticated_headers, "Content-Type": "application/json"}
    )
    
    assert response.status_code == 422

def test_missing_required_fields(client, authenticated_headers):
    """å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ å¦‚ãƒ†ã‚¹ãƒˆ"""
    incomplete_data = {
        "meeting_title": "Test Meeting"
        # meeting_date, participants, transcript_text ãŒæ¬ å¦‚
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=incomplete_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 422

def test_invalid_date_format(client, authenticated_headers):
    """ç„¡åŠ¹ãªæ—¥ä»˜å½¢å¼ãƒ†ã‚¹ãƒˆ"""
    invalid_date_data = {
        "meeting_title": "Date Format Test",
        "meeting_date": "invalid-date-format",
        "participants": ["Alice"],
        "transcript_text": "Test transcript",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=invalid_date_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 422

def test_empty_participants_list(client, authenticated_headers):
    """ç©ºã®å‚åŠ è€…ãƒªã‚¹ãƒˆãƒ†ã‚¹ãƒˆ"""
    empty_participants_data = {
        "meeting_title": "Empty Participants Test",
        "meeting_date": "2024-01-15T10:00:00",
        "participants": [],
        "transcript_text": "Test transcript",
    }
    
    response = client.post(
        "/api/v1/minutes/generate",
        json=empty_participants_data,
        headers=authenticated_headers
    )
    
    assert response.status_code == 422
```

## 5. ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (CI) è¨­å®š

### 5.1 GitHub Actionsè¨­å®šä¾‹
```yaml
# .github/workflows/test.yml
name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10, 3.11]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run tests with pytest
      run: |
        pytest --cov=src --cov-report=xml --cov-report=term
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Run security scan
      run: |
        pip install bandit safety
        bandit -r src/
        safety check --json
    
    - name: Run dependency check
      run: |
        pip install pip-audit
        pip-audit
```

### 5.2 ãƒ†ã‚¹ãƒˆå“è³ªã‚²ãƒ¼ãƒˆ
```yaml
# .github/workflows/quality-gate.yml
name: Quality Gate

on:
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run quality checks
      run: |
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆ90%ä»¥ä¸Šï¼‰
        pytest --cov=src --cov-fail-under=90
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆï¼ˆ100%ãƒ‘ã‚¹ï¼‰
        pytest tests/test_security.py -v
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        pytest tests/test_performance.py -v
        
        # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
        flake8 src/ --max-line-length=100
        black --check src/
        isort --check-only src/
```

## 6. ãƒ†ã‚¹ãƒˆå“è³ªæŒ‡æ¨™

### 6.1 ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™
- **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 90%ä»¥ä¸Š
- **ãƒ–ãƒ©ãƒ³ãƒã‚«ãƒãƒ¬ãƒƒã‚¸**: 85%ä»¥ä¸Š
- **é–¢æ•°ã‚«ãƒãƒ¬ãƒƒã‚¸**: 95%ä»¥ä¸Š

### 6.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™
- **API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 95%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ5ç§’ä»¥å†…
- **åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§å¯¾å¿œ
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: 512MBä»¥ä¸‹

### 6.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŒ‡æ¨™
- **èªè¨¼ãƒ†ã‚¹ãƒˆ**: 100%ãƒ‘ã‚¹
- **å…¥åŠ›å€¤æ¤œè¨¼ãƒ†ã‚¹ãƒˆ**: 100%ãƒ‘ã‚¹
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§**: 0ä»¶

### 6.4 ä¿¡é ¼æ€§æŒ‡æ¨™
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ**: 100%ãƒ‘ã‚¹
- **ä¾‹å¤–å‡¦ç†ã‚«ãƒãƒ¬ãƒƒã‚¸**: 90%ä»¥ä¸Š
- **éšœå®³å¾©æ—§ãƒ†ã‚¹ãƒˆ**: 100%ãƒ‘ã‚¹

## 7. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ‰‹é †

### 7.1 ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
```bash
# å…¨ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/test_security.py tests/test_performance.py tests/test_error_handling.py tests/test_input_validation.py

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest --cov=src --cov-report=html --cov-report=term tests/test_security.py tests/test_performance.py tests/test_error_handling.py

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
pytest tests/test_security.py -v

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
pytest tests/test_performance.py -v

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
pytest tests/test_error_handling.py -v

# ä¸¦åˆ—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest -n auto tests/test_performance.py
```

### 7.2 CI/CDçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# CIç’°å¢ƒã§ã®å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest --cov=src --cov-report=xml --cov-fail-under=90 --tb=short

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
bandit -r src/ -f json -o security-report.json
safety check --json --output safety-report.json

# å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
flake8 src/ --output-file=flake8-report.txt
black --check src/
isort --check-only src/
```

## 8. ãƒ†ã‚¹ãƒˆä¿å®ˆãƒ»æ›´æ–°

### 8.1 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†
- ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å®šæœŸæ›´æ–°
- ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®æœ€æ–°åŒ–
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å®šæœŸãƒªã‚»ãƒƒãƒˆ

### 8.2 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ æŒ‡é‡
- æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®å¯¾å¿œãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
- ãƒã‚°ä¿®æ­£æ™‚ã®å›å¸°ãƒ†ã‚¹ãƒˆè¿½åŠ 
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶å¤‰æ›´æ™‚ã®ãƒ†ã‚¹ãƒˆæ›´æ–°

### 8.3 ãƒ†ã‚¹ãƒˆçµæœåˆ†æ
- å¤±æ•—ãƒ†ã‚¹ãƒˆã®åŸå› åˆ†æ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ã®ç›£è¦–
- ã‚«ãƒãƒ¬ãƒƒã‚¸ä½ä¸‹ã®é˜²æ­¢

### 8.4 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆæ›´æ–°
- æ–°ã—ã„è„†å¼±æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ 
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®åæ˜ 
- è„…å¨ãƒ¢ãƒ‡ãƒ«ã®å®šæœŸè¦‹ç›´ã—

## 9. å‚è€ƒè³‡æ–™

- [FastAPI Testing Documentation](https://fastapi.tiangolo.com/tutorial/testing/)
- [pytest Documentation](https://docs.pytest.org/)
- [TestClient Documentation](https://fastapi.tiangolo.com/tutorial/testing/#using-testclient)
- [pytest-asyncio Documentation](https://pytest-asyncio.readthedocs.io/)
- [unittest.mock Documentation](https://docs.python.org/3/library/unittest.mock.html)
- [Security Testing Best Practices](https://owasp.org/www-project-web-security-testing-guide/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Python Security Best Practices](https://python.org/dev/security/)
- [Performance Testing Guidelines](https://docs.python.org/3/library/profile.html)
