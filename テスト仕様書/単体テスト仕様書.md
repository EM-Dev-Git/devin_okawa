# FastAPI 議事録生成アプリ 単体テスト仕様書

## 1. テスト概要

### 1.1 テスト目的
FastAPIを使用した議事録生成アプリケーションの個別モジュール・コンポーネントの品質保証を行う。
各モジュールが独立して正しく動作することを確認し、単体レベルでの不具合を早期発見する。

### 1.2 テスト対象
- ユーザーストアモジュール（データ管理）
- 認証モジュール（パスワードハッシュ、JWT処理）
- Azure OpenAI クライアントモジュール（初期化、基本機能）
- 設定モジュール（環境変数読み込み）

### 1.3 テスト環境
- **テストフレームワーク**: pytest
- **モック**: unittest.mock
- **カバレッジ**: pytest-cov
- **Python バージョン**: 3.8+

### 1.4 テスト戦略
- **独立性**: 各テストは他のテストに依存しない
- **モック使用**: 外部依存関係をモックで置き換え
- **境界値テスト**: 正常値・異常値・境界値をテスト
- **例外処理**: エラーケースの適切な処理を確認

## 2. テスト環境セットアップ

### 2.1 テスト用依存関係
```txt
# requirements-test.txt
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
pytest-mock==3.12.0
```

### 2.2 テスト設定ファイル
```python
# conftest.py
import pytest
from src.modules.user_store import user_store

@pytest.fixture
def clean_user_store():
    user_store.clear_all_users()
    yield
    user_store.clear_all_users()

@pytest.fixture
def test_user_data():
    return {
        "username": "testuser",
        "email": "test@example.com",
        "password": "testpassword123"
    }
```

### 2.3 テスト用環境変数
```python
# test_config.py
import os
from src.config import Settings

def get_test_settings():
    return Settings(
        azure_openai_api_key="test_key",
        azure_openai_model="gpt-4",
        azure_openai_version="2024-02-15-preview",
        azure_openai_endpoint="https://test.openai.azure.com/",
        jwt_secret_key="test_secret_key_for_testing_only",
        jwt_algorithm="HS256",
        jwt_expire_minutes=30,
        app_name="Test Meeting Minutes Generator",
        app_version="1.0.0-test",
        debug=True
    )
```

## 3. 単体テスト仕様

### 3.1 ユーザーストアテスト (test_user_store.py)

#### 3.1.1 ユーザー作成テスト
```python
def test_create_user(clean_user_store):
    """ユーザー作成機能のテスト"""
    # テストデータ
    username = "testuser"
    email = "test@example.com"
    hashed_password = "hashed_password_123"
    
    # ユーザー作成
    user = user_store.create_user(username, email, hashed_password)
    
    # 検証
    assert user["username"] == username
    assert user["email"] == email
    assert user["hashed_password"] == hashed_password
    assert user["is_active"] is True
    assert "id" in user
    assert "created_at" in user
    assert "updated_at" in user
```

#### 3.1.2 ユーザー取得テスト
```python
def test_get_user_by_username(clean_user_store):
    """ユーザー名によるユーザー取得テスト"""
    # テストユーザー作成
    username = "testuser"
    user_store.create_user(username, "test@example.com", "hashed_password")
    
    # ユーザー取得
    retrieved_user = user_store.get_user_by_username(username)
    
    # 検証
    assert retrieved_user is not None
    assert retrieved_user["username"] == username

def test_get_user_by_email(clean_user_store):
    """メールアドレスによるユーザー取得テスト"""
    # テストユーザー作成
    email = "test@example.com"
    user_store.create_user("testuser", email, "hashed_password")
    
    # ユーザー取得
    retrieved_user = user_store.get_user_by_email(email)
    
    # 検証
    assert retrieved_user is not None
    assert retrieved_user["email"] == email

def test_get_nonexistent_user(clean_user_store):
    """存在しないユーザーの取得テスト"""
    # 存在しないユーザーの取得
    user = user_store.get_user_by_username("nonexistent")
    
    # 検証
    assert user is None
```

#### 3.1.3 ユーザー更新・削除テスト
```python
def test_update_user(clean_user_store):
    """ユーザー情報更新テスト"""
    # テストユーザー作成
    username = "testuser"
    user_store.create_user(username, "test@example.com", "hashed_password")
    
    # ユーザー更新
    updated_user = user_store.update_user(username, email="updated@example.com")
    
    # 検証
    assert updated_user is not None
    assert updated_user["email"] == "updated@example.com"
    assert "updated_at" in updated_user

def test_delete_user(clean_user_store):
    """ユーザー削除テスト"""
    # テストユーザー作成
    username = "testuser"
    user_store.create_user(username, "test@example.com", "hashed_password")
    
    # ユーザー削除
    result = user_store.delete_user(username)
    
    # 検証
    assert result is True
    assert user_store.get_user_by_username(username) is None
```

### 3.2 認証モジュールテスト (test_auth.py)

#### 3.2.1 パスワードハッシュテスト
```python
from src.modules.auth import get_password_hash, verify_password

def test_password_hashing():
    """パスワードハッシュ化テスト"""
    password = "testpassword123"
    
    # パスワードハッシュ化
    hashed = get_password_hash(password)
    
    # 検証
    assert hashed != password
    assert verify_password(password, hashed) is True
    assert verify_password("wrongpassword", hashed) is False

def test_password_hashing_uniqueness():
    """パスワードハッシュの一意性テスト"""
    password = "testpassword123"
    hash1 = get_password_hash(password)
    hash2 = get_password_hash(password)
    
    # bcryptは同じパスワードでも異なるハッシュを生成する
    assert hash1 != hash2
    
    # しかし両方とも元のパスワードで検証できる
    assert verify_password(password, hash1) is True
    assert verify_password(password, hash2) is True
```

#### 3.2.2 JWTトークンテスト
```python
from src.modules.auth import create_access_token, verify_token
from fastapi import HTTPException
import pytest
import jwt
from datetime import datetime, timedelta
from src.config import settings

def test_create_access_token():
    """JWTトークン作成テスト"""
    data = {"sub": "testuser"}
    
    # トークン作成
    token = create_access_token(data)
    
    # 検証
    assert isinstance(token, str)
    assert len(token) > 0

def test_verify_valid_token():
    """有効なJWTトークン検証テスト"""
    data = {"sub": "testuser"}
    token = create_access_token(data)
    
    # トークン検証
    credentials_exception = HTTPException(status_code=401, detail="Invalid token")
    token_data = verify_token(token, credentials_exception)
    
    # 検証
    assert token_data.username == "testuser"

def test_verify_invalid_token():
    """無効なJWTトークン検証テスト"""
    invalid_token = "invalid.token.here"
    
    # トークン検証（例外発生を期待）
    credentials_exception = HTTPException(status_code=401, detail="Invalid token")
    
    with pytest.raises(HTTPException):
        verify_token(invalid_token, credentials_exception)

def test_expired_token():
    """期限切れトークンテスト"""
    # 期限切れトークンを手動作成
    expired_payload = {
        "sub": "testuser",
        "exp": datetime.utcnow() - timedelta(minutes=1)  # 1分前に期限切れ
    }
    expired_token = jwt.encode(expired_payload, settings.jwt_secret_key, algorithm=settings.jwt_algorithm)
    
    credentials_exception = HTTPException(status_code=401, detail="Invalid token")
    
    with pytest.raises(HTTPException):
        verify_token(expired_token, credentials_exception)
```

#### 3.2.3 ユーザー認証テスト
```python
from src.modules.auth import authenticate_user, create_user

def test_authenticate_valid_user(clean_user_store):
    """有効なユーザー認証テスト"""
    # テストユーザー作成
    username = "testuser"
    password = "testpassword123"
    create_user(username, "test@example.com", password)
    
    # ユーザー認証
    user = authenticate_user(username, password)
    
    # 検証
    assert user is not False
    assert user["username"] == username

def test_authenticate_invalid_user(clean_user_store):
    """無効なユーザー認証テスト"""
    # 存在しないユーザーの認証
    user = authenticate_user("nonexistent", "password")
    
    # 検証
    assert user is False

def test_authenticate_wrong_password(clean_user_store):
    """間違ったパスワードでの認証テスト"""
    # テストユーザー作成
    username = "testuser"
    create_user(username, "test@example.com", "correctpassword")
    
    # 間違ったパスワードで認証
    user = authenticate_user(username, "wrongpassword")
    
    # 検証
    assert user is False
```

### 3.3 Azure OpenAI クライアントテスト (test_azure_openai_client.py)

#### 3.3.1 クライアント初期化テスト
```python
import pytest
from unittest.mock import Mock, patch
from src.modules.azure_openai_client import AzureOpenAIClient

def test_azure_openai_client_initialization():
    """Azure OpenAI クライアント初期化テスト"""
    client = AzureOpenAIClient(
        azure_openai_api_key="test_key",
        azure_openai_endpoint="https://test.openai.azure.com/",
        azure_openai_model="gpt-4",
        azure_openai_version="2024-02-15-preview"
    )
    
    assert client.azure_openai_api_key == "test_key"
    assert client.azure_openai_model == "gpt-4"
    assert client.azure_openai_endpoint == "https://test.openai.azure.com/"
    assert client.azure_openai_version == "2024-02-15-preview"

def test_azure_openai_client_missing_config():
    """Azure OpenAI クライアント設定不足テスト"""
    with pytest.raises(ValueError):
        AzureOpenAIClient(
            azure_openai_api_key="",
            azure_openai_endpoint="https://test.openai.azure.com/",
            azure_openai_model="gpt-4",
            azure_openai_version="2024-02-15-preview"
        )

def test_azure_openai_client_missing_endpoint():
    """Azure OpenAI クライアントエンドポイント不足テスト"""
    with pytest.raises(ValueError):
        AzureOpenAIClient(
            azure_openai_api_key="test_key",
            azure_openai_endpoint="",
            azure_openai_model="gpt-4",
            azure_openai_version="2024-02-15-preview"
        )

def test_azure_openai_client_missing_model():
    """Azure OpenAI クライアントモデル不足テスト"""
    with pytest.raises(ValueError):
        AzureOpenAIClient(
            azure_openai_api_key="test_key",
            azure_openai_endpoint="https://test.openai.azure.com/",
            azure_openai_model="",
            azure_openai_version="2024-02-15-preview"
        )
```

#### 3.3.2 議事録生成機能テスト
```python
@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_generate_minutes_success(mock_azure_openai):
    """議事録生成成功テスト"""
    # モックレスポンス設定
    mock_response = Mock()
    mock_response.choices[0].message.content = "Generated minutes content"
    mock_azure_openai.return_value.chat.completions.create.return_value = mock_response
    
    # クライアント作成
    client = AzureOpenAIClient(
        azure_openai_api_key="test_key",
        azure_openai_endpoint="https://test.openai.azure.com/",
        azure_openai_model="gpt-4",
        azure_openai_version="2024-02-15-preview"
    )
    
    # 議事録生成
    result = client.generate_minutes("Test prompt")
    
    # 検証
    assert result == "Generated minutes content"
    mock_azure_openai.return_value.chat.completions.create.assert_called_once()

@patch('src.modules.azure_openai_client.AzureOpenAI')
def test_generate_minutes_api_error(mock_azure_openai):
    """議事録生成APIエラーテスト"""
    # APIエラーをシミュレート
    mock_azure_openai.return_value.chat.completions.create.side_effect = Exception("API Error")
    
    # クライアント作成
    client = AzureOpenAIClient(
        azure_openai_api_key="test_key",
        azure_openai_endpoint="https://test.openai.azure.com/",
        azure_openai_model="gpt-4",
        azure_openai_version="2024-02-15-preview"
    )
    
    # 議事録生成（例外発生を期待）
    with pytest.raises(Exception):
        client.generate_minutes("Test prompt")
```

## 4. テスト実行手順

### 4.1 単体テスト実行コマンド
```bash
# 全単体テスト実行
pytest tests/test_user_store.py tests/test_auth.py tests/test_azure_openai_client.py

# カバレッジ付き単体テスト実行
pytest --cov=src.modules --cov-report=html tests/test_user_store.py tests/test_auth.py tests/test_azure_openai_client.py

# 特定のテストファイル実行
pytest tests/test_auth.py

# 特定のテスト関数実行
pytest tests/test_auth.py::test_password_hashing

# 詳細出力付きテスト実行
pytest -v tests/test_user_store.py
```

### 4.2 テスト結果の確認
```bash
# HTMLカバレッジレポート確認
open htmlcov/index.html

# テスト結果ログ確認
pytest --tb=short tests/test_auth.py  # 短縮トレースバック
pytest --tb=long tests/test_auth.py   # 詳細トレースバック
```

## 5. 品質指標

### 5.1 カバレッジ目標
- **単体テストカバレッジ**: 95%以上
- **ブランチカバレッジ**: 90%以上
- **関数カバレッジ**: 98%以上

### 5.2 テスト品質指標
- **テスト実行時間**: 各テストファイル30秒以内
- **テスト独立性**: 100%（他のテストに依存しない）
- **モック使用率**: 外部依存関係100%モック化

## 6. 参考資料

- [pytest Documentation](https://docs.pytest.org/)
- [unittest.mock Documentation](https://docs.python.org/3/library/unittest.mock.html)
- [FastAPI Testing Documentation](https://fastapi.tiangolo.com/tutorial/testing/)
- [Python Testing Best Practices](https://docs.python-guide.org/writing/tests/)
