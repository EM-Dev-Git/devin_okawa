# 実装計画書01 - トランスクリプト議事録生成システム

## 1. プロジェクト概要

FastAPI上でAzure OpenAIを通してトランスクリプトから議事録を生成するシステムの実装計画書です。

### 1.1 システム目的
- トランスクリプトファイルを入力として受け取り、Azure OpenAIを使用して構造化された議事録を自動生成する
- Pydantic V2を基盤とした型安全なAPIシステムの構築
- ログ機能による運用監視の実現

## 2. ディレクトリ構成

```
project/
├── env/
│   └── .env
├── src/
│   ├── __init__.py
│   ├── modules/
│   │   ├── __init__.py
│   │   ├── azure_openai_client.py
│   │   ├── transcript_processor.py
│   │   └── logger.py
│   ├── routers/
│   │   ├── __init__.py
│   │   └── minutes.py
│   └── schemas/
│       ├── __init__.py
│       ├── transcript.py
│       └── minutes.py
├── main.py
└── config.py
```

## 3. 環境変数設定

### 3.1 .env ファイル構成
```env
AZURE_OPENAI_API_KEY=your_azure_openai_api_key_here
AZURE_OPENAI_MODEL=gpt-4
AZURE_OPENAI_VERSION=2023-12-01-preview
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
```

### 3.2 環境変数の取り扱い
- 全ての環境変数はstr型として取得
- config.pyで一元管理
- .env以外の設定は追加しない

## 4. 技術仕様

### 4.1 フレームワーク・ライブラリ
- **FastAPI**: Web APIフレームワーク
- **Pydantic V2**: データバリデーション・シリアライゼーション
- **Azure OpenAI**: AI議事録生成エンジン
- **Python Logging**: ログ機能

### 4.2 Pydantic V2 対応
- BaseModel継承によるスキーマ定義
- Field()を使用したバリデーション
- ConfigDict使用による設定管理

## 5. 実装詳細

### 5.1 config.py
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    azure_openai_api_key: str
    azure_openai_model: str
    azure_openai_version: str
    azure_openai_endpoint: str
    
    class Config:
        env_file = "env/.env"

settings = Settings()
```

### 5.2 src/modules/azure_openai_client.py
```python
from openai import AzureOpenAI
from config import settings
import logging

class AzureOpenAIClient:
    def __init__(self):
        self.client = AzureOpenAI(
            api_key=settings.azure_openai_api_key,
            api_version=settings.azure_openai_version,
            azure_endpoint=settings.azure_openai_endpoint
        )
        self.model = settings.azure_openai_model
        self.logger = logging.getLogger(__name__)
    
    async def generate_minutes(self, transcript: str) -> str:
        """トランスクリプトから議事録を生成"""
        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": "あなたは議事録作成の専門家です。"},
                    {"role": "user", "content": f"以下のトランスクリプトから議事録を作成してください:\n{transcript}"}
                ]
            )
            return response.choices[0].message.content
        except Exception as e:
            self.logger.error(f"議事録生成エラー: {e}")
            raise
```

### 5.3 src/schemas/transcript.py
```python
from pydantic import BaseModel, Field
from typing import Optional

class TranscriptRequest(BaseModel):
    content: str = Field(..., description="トランスクリプト内容")
    meeting_title: Optional[str] = Field(None, description="会議タイトル")
    participants: Optional[list[str]] = Field(None, description="参加者リスト")
    
    model_config = {
        "json_schema_extra": {
            "example": {
                "content": "会議のトランスクリプト内容...",
                "meeting_title": "週次定例会議",
                "participants": ["田中", "佐藤", "鈴木"]
            }
        }
    }
```

### 5.4 src/schemas/minutes.py
```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional

class MinutesResponse(BaseModel):
    id: str = Field(..., description="議事録ID")
    title: str = Field(..., description="会議タイトル")
    content: str = Field(..., description="議事録内容")
    created_at: datetime = Field(..., description="作成日時")
    participants: Optional[list[str]] = Field(None, description="参加者リスト")
    
    model_config = {
        "json_schema_extra": {
            "example": {
                "id": "minutes_001",
                "title": "週次定例会議",
                "content": "## 議事録\n\n### 議題1\n...",
                "created_at": "2025-01-24T10:00:00Z",
                "participants": ["田中", "佐藤", "鈴木"]
            }
        }
    }
```

### 5.5 src/modules/transcript_processor.py
```python
from .azure_openai_client import AzureOpenAIClient
from ..schemas.transcript import TranscriptRequest
from ..schemas.minutes import MinutesResponse
import uuid
from datetime import datetime
import logging

class TranscriptProcessor:
    def __init__(self):
        self.openai_client = AzureOpenAIClient()
        self.logger = logging.getLogger(__name__)
    
    async def process_transcript(self, request: TranscriptRequest) -> MinutesResponse:
        """トランスクリプトを処理して議事録を生成"""
        self.logger.info(f"トランスクリプト処理開始: {request.meeting_title}")
        
        try:
            # Azure OpenAIで議事録生成
            minutes_content = await self.openai_client.generate_minutes(request.content)
            
            # レスポンス作成
            response = MinutesResponse(
                id=f"minutes_{uuid.uuid4().hex[:8]}",
                title=request.meeting_title or "議事録",
                content=minutes_content,
                created_at=datetime.utcnow(),
                participants=request.participants
            )
            
            self.logger.info(f"議事録生成完了: {response.id}")
            return response
            
        except Exception as e:
            self.logger.error(f"トランスクリプト処理エラー: {e}")
            raise
```

### 5.6 src/modules/logger.py
```python
import logging
import sys
from datetime import datetime

def setup_logger():
    """ログ設定の初期化"""
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)
    
    # コンソールハンドラー
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(logging.INFO)
    
    # フォーマッター
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    console_handler.setFormatter(formatter)
    
    logger.addHandler(console_handler)
    
    return logger
```

### 5.7 src/routers/minutes.py
```python
from fastapi import APIRouter, HTTPException
from ..schemas.transcript import TranscriptRequest
from ..schemas.minutes import MinutesResponse
from ..modules.transcript_processor import TranscriptProcessor
import logging

router = APIRouter(prefix="/minutes", tags=["議事録"])
processor = TranscriptProcessor()
logger = logging.getLogger(__name__)

@router.post("/generate", response_model=MinutesResponse)
async def generate_minutes(request: TranscriptRequest):
    """トランスクリプトから議事録を生成"""
    try:
        logger.info("議事録生成リクエスト受信")
        result = await processor.process_transcript(request)
        return result
    except Exception as e:
        logger.error(f"議事録生成API エラー: {e}")
        raise HTTPException(status_code=500, detail="議事録生成に失敗しました")

@router.get("/health")
async def health_check():
    """ヘルスチェック"""
    return {"status": "healthy", "service": "minutes-api"}
```

### 5.8 main.py
```python
from fastapi import FastAPI
from src.routers import minutes
from src.modules.logger import setup_logger
import logging

# ログ設定
setup_logger()
logger = logging.getLogger(__name__)

# FastAPIアプリケーション
app = FastAPI(
    title="議事録生成API",
    description="Azure OpenAIを使用してトランスクリプトから議事録を生成するAPI",
    version="1.0.0"
)

# ルーター登録
app.include_router(minutes.router)

@app.get("/")
async def root():
    """ルートエンドポイント"""
    logger.info("ルートエンドポイントアクセス")
    return {"message": "議事録生成API", "version": "1.0.0"}

@app.on_event("startup")
async def startup_event():
    """アプリケーション起動時の処理"""
    logger.info("議事録生成API 起動完了")

@app.on_event("shutdown")
async def shutdown_event():
    """アプリケーション終了時の処理"""
    logger.info("議事録生成API 終了")
```

## 6. __init__.py ファイル

### 6.1 ModuleNotFoundError対策
全てのディレクトリに`__init__.py`ファイルを配置してPythonパッケージとして認識させる：

- `src/__init__.py`
- `src/modules/__init__.py`
- `src/routers/__init__.py`
- `src/schemas/__init__.py`

各ファイルは空ファイルまたは必要な場合のみimport文を記載。

## 7. 依存関係

### 7.1 requirements.txt
```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
pydantic-settings==2.1.0
openai==1.3.7
python-multipart==0.0.6
```

## 8. API仕様

### 8.1 エンドポイント一覧

| メソッド | パス | 説明 |
|---------|------|------|
| GET | / | ルートエンドポイント |
| POST | /minutes/generate | 議事録生成 |
| GET | /minutes/health | ヘルスチェック |

### 8.2 リクエスト例
```json
{
  "content": "会議のトランスクリプト内容...",
  "meeting_title": "週次定例会議",
  "participants": ["田中", "佐藤", "鈴木"]
}
```

### 8.3 レスポンス例
```json
{
  "id": "minutes_a1b2c3d4",
  "title": "週次定例会議",
  "content": "## 議事録\n\n### 議題1\n...",
  "created_at": "2025-01-24T10:00:00Z",
  "participants": ["田中", "佐藤", "鈴木"]
}
```

## 9. 実装手順

### 9.1 Phase 1: 基盤構築
1. ディレクトリ構造作成
2. 環境変数設定（.env）
3. 設定ファイル作成（config.py）
4. 全ディレクトリに__init__.py追加

### 9.2 Phase 2: コア機能実装
1. Azure OpenAIクライアント実装
2. Pydantic V2スキーマ定義
3. トランスクリプト処理ロジック実装
4. ログ機能実装

### 9.3 Phase 3: API実装
1. FastAPIルーター実装
2. メインアプリケーション作成
3. エラーハンドリング実装

### 9.4 Phase 4: テスト・検証
1. 単体テスト実行
2. API動作確認
3. ログ出力確認
4. Azure OpenAI連携テスト

## 10. 注意事項

### 10.1 セキュリティ
- Azure OpenAI APIキーの適切な管理
- .envファイルのgit除外設定

### 10.2 エラーハンドリング
- Azure OpenAI API呼び出し失敗時の適切な処理
- バリデーションエラーの詳細メッセージ

### 10.3 ログ管理
- 適切なログレベル設定
- 個人情報を含む可能性のあるトランスクリプト内容のログ出力制御

## 11. 今後の拡張予定

- ファイルアップロード機能
- 議事録テンプレート機能
- 複数言語対応
- データベース連携
- 認証機能

---

**作成日**: 2025年1月24日  
**バージョン**: 1.0  
**作成者**: AI Assistant
