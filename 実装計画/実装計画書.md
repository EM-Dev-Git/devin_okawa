# 議事録作成API実装計画書

## 概要
既存のトランスクリプトから議事録を自動生成するFastAPIシステムを拡張し、JWT認証、データベース統合、ログ機能を追加する実装計画

## 現在の状況
- 既存: OpenAI APIを使用した議事録生成機能（meeting_minutes_api/app/main.py）
- 追加要件: JWT認証、データベース、ログ機能、ディレクトリ再構成

## 要件
- OpenAI APIを使用した議事録生成（既存機能を保持）
- JWTトークン認証によるログイン機能
- UserID、PasswordのDB保管
- logging機能の追加
- 環境変数の外部化
- ディレクトリ構成: routers、modules、schemas

## 実装アプローチ
既存のmeeting_minutes_apiを基盤として、段階的に機能を追加・再構成する

## 新しいディレクトリ構造
```
meeting_minutes_api/
├── app/
│   ├── main.py                 # FastAPIアプリケーション（更新）
│   ├── config.py               # 設定管理（新規）
│   ├── database.py             # データベース接続（新規）
│   ├── dependencies.py         # 依存関係（新規）
│   ├── routers/               # APIルーター（新規）
│   │   ├── __init__.py
│   │   ├── auth.py            # 認証エンドポイント
│   │   ├── minutes.py         # 議事録生成エンドポイント
│   │   └── users.py           # ユーザー管理エンドポイント
│   ├── modules/               # ビジネスロジック（新規）
│   │   ├── __init__.py
│   │   ├── auth.py            # 認証ロジック
│   │   ├── transcript_processor.py  # 既存ロジックを移行
│   │   ├── minutes_formatter.py     # 既存ロジックを移行
│   │   └── logger.py          # ログ管理
│   └── schemas/               # Pydanticスキーマ（新規）
│       ├── __init__.py
│       ├── auth.py            # 認証関連スキーマ
│       ├── minutes.py         # 議事録関連スキーマ（既存から移行）
│       └── users.py           # ユーザー関連スキーマ
├── alembic/                   # データベースマイグレーション（新規）
├── logs/                      # ログファイル（新規）
├── .env                       # 環境変数（既存を拡張）
├── pyproject.toml            # 依存関係（既存を拡張）
└── README.md                 # ドキュメント（既存を更新）
```

## データベース設計

### Usersテーブル
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Meeting_Minutesテーブル
```sql
CREATE TABLE meeting_minutes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    title VARCHAR(255) NOT NULL,
    date DATE NOT NULL,
    location VARCHAR(255),
    participants TEXT[],
    absent_members TEXT[],
    facilitator VARCHAR(100),
    transcript TEXT NOT NULL,
    formatted_minutes TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## API エンドポイント設計

### 認証関連 (/auth)
- `POST /auth/login` - ログイン（JWTトークン発行）
- `POST /auth/refresh` - トークンリフレッシュ
- `POST /auth/logout` - ログアウト

### ユーザー管理 (/users)
- `POST /users/register` - ユーザー登録
- `GET /users/me` - 現在のユーザー情報取得
- `PUT /users/me` - ユーザー情報更新

### 議事録生成 (/minutes)
- `POST /minutes/generate` - 議事録生成（既存機能を認証付きで移行）
- `GET /minutes/` - 議事録一覧取得
- `GET /minutes/{id}` - 特定の議事録取得
- `DELETE /minutes/{id}` - 議事録削除

## 技術スタック

### 新規追加ライブラリ
- **SQLAlchemy**: ORM
- **Alembic**: データベースマイグレーション
- **python-jose[cryptography]**: JWT処理
- **passlib[bcrypt]**: パスワードハッシュ化
- **psycopg2-binary**: PostgreSQL接続

### 既存ライブラリ（保持）
- **FastAPI**: Webフレームワーク
- **openai**: OpenAI API
- **python-dotenv**: 環境変数管理
- **pydantic**: データ検証

## 実装フェーズ

### Phase 1: 基盤準備（1日）
1. 新しいディレクトリ構造作成
2. 既存コードのリファクタリング（modules/に移行）
3. 依存関係の追加（pyproject.toml更新）
4. データベース設定とマイグレーション準備

### Phase 2: 認証システム（1-2日）
1. ユーザーモデルとスキーマ作成
2. JWT認証ロジック実装
3. 認証エンドポイント作成
4. 認証ミドルウェア実装

### Phase 3: 議事録機能統合（1日）
1. 既存の議事録生成機能をrouters/minutes.pyに移行
2. 認証が必要なエンドポイントに変更
3. データベースへの保存機能追加
4. 議事録履歴管理機能

### Phase 4: ログとセキュリティ（1日）
1. ログシステム実装
2. セキュリティ強化
3. エラーハンドリング改善
4. 環境変数の完全外部化

### Phase 5: テストと最終調整（1日）
1. 単体・統合テスト
2. API ドキュメント更新
3. 最終動作確認

## 環境変数設定 (.env)

```env
# データベース
DATABASE_URL=postgresql://user:password@localhost/meeting_minutes_db

# JWT設定
SECRET_KEY=your-secret-key-here
ACCESS_TOKEN_EXPIRE_MINUTES=30

# OpenAI API（既存）
OPENAI_API_KEY=your-openai-api-key

# ログ設定
LOG_LEVEL=INFO
LOG_FILE_PATH=logs/app.log

# アプリケーション設定
DEBUG=False
CORS_ORIGINS=["http://localhost:3000"]
```

## 移行戦略

### 既存コードの保持
- TranscriptProcessor クラス → modules/transcript_processor.py
- MeetingMinutesFormatter クラス → modules/minutes_formatter.py
- Pydanticモデル → schemas/minutes.py
- 既存の /generate-minutes エンドポイント → /minutes/generate（認証付き）

### 段階的実装
1. 既存機能を壊さずに新機能を追加
2. 認証なしでも動作するオプション（開発時）
3. 段階的にセキュリティを強化

## 完了基準

- [ ] 新しいディレクトリ構造の作成完了
- [ ] 既存コードのリファクタリング完了
- [ ] JWT認証システムの動作確認
- [ ] データベース統合の動作確認
- [ ] ログシステムの動作確認
- [ ] 既存の議事録生成機能の保持確認
- [ ] 全APIエンドポイントのテスト完了
- [ ] セキュリティテストの完了

## リスク対策

### 既存機能の保護
- 既存のTranscriptProcessorとMeetingMinutesFormatterを慎重に移行
- OpenAI API統合の動作確認を重視
- 段階的な実装で各フェーズでテスト

### 開発効率
- SQLiteを開発用DBとして使用（本番はPostgreSQL）
- 認証をオプションにして開発時の利便性を確保
- 既存の.envファイルを基盤として拡張
