# 議事録作成API実装計画書

## 概要
トランスクリプトから議事録を自動生成するFastAPI システムの実装計画書

## 要件
- OpenAI APIを使用した議事録生成
- JWTトークン認証によるログイン機能
- データベースでのユーザー管理
- ログ機能の実装
- 環境変数の外部化

## システム構成

### ディレクトリ構造
```
meeting_minutes_api/
├── app/
│   ├── main.py                 # FastAPIアプリケーション
│   ├── config.py               # 設定管理
│   ├── database.py             # データベース接続
│   ├── dependencies.py         # 依存関係
│   ├── routers/               # APIルーター
│   │   ├── __init__.py
│   │   ├── auth.py            # 認証関連エンドポイント
│   │   ├── minutes.py         # 議事録生成エンドポイント
│   │   └── users.py           # ユーザー管理エンドポイント
│   ├── modules/               # ビジネスロジック
│   │   ├── __init__.py
│   │   ├── auth.py            # 認証ロジック
│   │   ├── transcript_processor.py  # トランスクリプト処理
│   │   ├── minutes_formatter.py     # 議事録フォーマット
│   │   └── logger.py          # ログ管理
│   └── schemas/               # Pydanticスキーマ
│       ├── __init__.py
│       ├── auth.py            # 認証関連スキーマ
│       ├── minutes.py         # 議事録関連スキーマ
│       └── users.py           # ユーザー関連スキーマ
├── alembic/                   # データベースマイグレーション
├── logs/                      # ログファイル
├── .env                       # 環境変数
├── pyproject.toml            # 依存関係
└── README.md                 # ドキュメント
```

## データベース設計

### Usersテーブル
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Meeting_Minutesテーブル
```sql
CREATE TABLE meeting_minutes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    title VARCHAR(255) NOT NULL,
    date DATE NOT NULL,
    location VARCHAR(255),
    participants TEXT[],
    absent_members TEXT[],
    facilitator VARCHAR(100),
    transcript TEXT NOT NULL,
    formatted_minutes TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## API エンドポイント設計

### 認証関連 (/auth)
- `POST /auth/login` - ログイン（JWTトークン発行）
- `POST /auth/refresh` - トークンリフレッシュ
- `POST /auth/logout` - ログアウト

### ユーザー管理 (/users)
- `POST /users/register` - ユーザー登録
- `GET /users/me` - 現在のユーザー情報取得
- `PUT /users/me` - ユーザー情報更新

### 議事録生成 (/minutes)
- `POST /minutes/generate` - 議事録生成
- `GET /minutes/` - 議事録一覧取得
- `GET /minutes/{id}` - 特定の議事録取得
- `DELETE /minutes/{id}` - 議事録削除

## 技術スタック

### フレームワーク・ライブラリ
- **FastAPI**: Webフレームワーク
- **SQLAlchemy**: ORM
- **Alembic**: データベースマイグレーション
- **PostgreSQL**: データベース
- **python-jose**: JWT処理
- **passlib**: パスワードハッシュ化
- **python-multipart**: ファイルアップロード
- **openai**: OpenAI API
- **python-dotenv**: 環境変数管理

### 認証・セキュリティ
- **JWT (JSON Web Token)**: 認証トークン
- **bcrypt**: パスワードハッシュ化
- **OAuth2**: 認証フロー

## 実装詳細

### 1. 認証システム (modules/auth.py)
```python
class AuthService:
    def __init__(self):
        self.pwd_context = CryptContext(schemes=["bcrypt"])
        self.secret_key = settings.SECRET_KEY
        self.algorithm = "HS256"
    
    def verify_password(self, plain_password: str, hashed_password: str) -> bool
    def get_password_hash(self, password: str) -> str
    def create_access_token(self, data: dict) -> str
    def verify_token(self, token: str) -> dict
```

### 2. トランスクリプト処理 (modules/transcript_processor.py)
```python
class TranscriptProcessor:
    def __init__(self):
        self.openai_client = OpenAI(api_key=settings.OPENAI_API_KEY)
    
    async def process_transcript(self, transcript: str, header: MeetingHeader) -> MeetingMinutes
    def _create_prompt(self, transcript: str) -> str
    def _parse_response(self, response: str) -> dict
```

### 3. ログ管理 (modules/logger.py)
```python
class LoggerConfig:
    @staticmethod
    def setup_logging():
        # ファイルローテーション設定
        # フォーマット設定
        # レベル設定
```

### 4. データベース接続 (database.py)
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

SQLALCHEMY_DATABASE_URL = settings.DATABASE_URL
engine = create_engine(SQLALCHEMY_DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()
```

## 環境変数設定 (.env)

```env
# データベース
DATABASE_URL=postgresql://user:password@localhost/meeting_minutes_db

# JWT設定
SECRET_KEY=your-secret-key-here
ACCESS_TOKEN_EXPIRE_MINUTES=30

# OpenAI API
OPENAI_API_KEY=your-openai-api-key

# ログ設定
LOG_LEVEL=INFO
LOG_FILE_PATH=logs/app.log

# アプリケーション設定
DEBUG=False
CORS_ORIGINS=["http://localhost:3000"]
```

## セキュリティ考慮事項

### 1. 認証・認可
- JWTトークンの適切な有効期限設定
- パスワードの強度チェック
- レート制限の実装

### 2. データ保護
- パスワードのハッシュ化（bcrypt）
- 機密情報の環境変数化
- HTTPS通信の強制

### 3. 入力検証
- Pydanticによるデータ検証
- SQLインジェクション対策
- XSS対策

## ログ設計

### ログレベル
- **ERROR**: システムエラー、API呼び出し失敗
- **WARNING**: 認証失敗、不正なリクエスト
- **INFO**: API呼び出し、ユーザーアクション
- **DEBUG**: 詳細なデバッグ情報

### ログフォーマット
```
[TIMESTAMP] [LEVEL] [MODULE] [USER_ID] MESSAGE
```

### ログローテーション
- 日次ローテーション
- 最大ファイルサイズ: 10MB
- 保持期間: 30日

## テスト計画

### 1. 単体テスト
- 各モジュールの個別テスト
- 認証ロジックのテスト
- データベース操作のテスト

### 2. 統合テスト
- API エンドポイントのテスト
- 認証フローのテスト
- OpenAI API統合テスト

### 3. セキュリティテスト
- 認証バイパステスト
- SQLインジェクションテスト
- XSSテスト

## 実装スケジュール

### Phase 1: 基盤構築 (1-2日)
- プロジェクト構造作成
- データベース設計・マイグレーション
- 基本設定ファイル作成

### Phase 2: 認証システム (2-3日)
- ユーザーモデル実装
- JWT認証実装
- 認証エンドポイント作成

### Phase 3: 議事録生成機能 (2-3日)
- OpenAI API統合
- トランスクリプト処理ロジック
- 議事録フォーマット機能

### Phase 4: ログ・セキュリティ (1-2日)
- ログシステム実装
- セキュリティ強化
- エラーハンドリング

### Phase 5: テスト・ドキュメント (1-2日)
- 単体・統合テスト
- API ドキュメント作成
- デプロイ準備

## 運用考慮事項

### 1. パフォーマンス
- データベース接続プール
- OpenAI APIのレート制限対応
- キャッシュ戦略

### 2. 監視
- ヘルスチェックエンドポイント
- メトリクス収集
- アラート設定

### 3. バックアップ
- データベースバックアップ
- ログファイルバックアップ
- 設定ファイルバックアップ

## 完了基準

- [ ] 全APIエンドポイントの実装完了
- [ ] JWT認証システムの動作確認
- [ ] データベース操作の正常動作
- [ ] OpenAI API統合の動作確認
- [ ] ログシステムの動作確認
- [ ] セキュリティテストの完了
- [ ] API ドキュメントの作成完了
- [ ] 単体・統合テストの完了

## リスク・課題

### 技術リスク
- OpenAI APIの制限・コスト
- データベースパフォーマンス
- JWT トークンのセキュリティ

### 対策
- APIレート制限の監視
- データベースインデックス最適化
- トークンの適切な管理・ローテーション

## 参考資料

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [JWT Best Practices](https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/)
- [OpenAI API Documentation](https://platform.openai.com/docs/)
