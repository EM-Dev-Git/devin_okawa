# 修正計画書01: 環境変数設定改善

## 📋 概要
現在のconfig.pyでAPIキーなどが直接代入されている問題を解決し、.envファイルから適切に環境変数を読み取る形に変更する。

## 🎯 修正目的
- セキュリティ向上：機密情報をコードから分離
- 環境別設定：開発・本番環境での設定切り替えを容易に
- ベストプラクティス準拠：12-Factor Appの設定管理原則に従う

## 📝 現在の問題点

### 1. config.py の問題
```python
# 現在の問題のあるコード (src/config.py:6-11)
azure_openai_api_key: str = "test_key_for_development"
azure_openai_endpoint: str = "https://test.openai.azure.com/"
jwt_secret_key: str = "test_secret_key_for_development_only_change_in_production"
```

**問題:**
- 機密情報がソースコードに直接記載
- 環境別の設定変更が困難
- セキュリティリスクが高い

### 2. .env ファイルの不整合
- .envファイルは存在するが、config.pyで無視されている
- デフォルト値が優先されてしまう

## 🔧 修正計画

### Phase 1: config.py の修正

#### 1.1 環境変数を必須フィールドに戻す
```python
# 修正後のコード
class Settings(BaseSettings):
    # 必須環境変数（デフォルト値なし）
    azure_openai_api_key: str
    azure_openai_endpoint: str
    jwt_secret_key: str
    
    # オプション環境変数（デフォルト値あり）
    azure_openai_model: str = "gpt-4"
    azure_openai_version: str = "2024-02-15-preview"
    jwt_algorithm: str = "HS256"
    jwt_expire_minutes: int = 30
    app_name: str = "Meeting Minutes Generator"
    app_version: str = "1.0.0"
    debug: bool = False
```

#### 1.2 環境変数の検証とエラーハンドリング追加
```python
# 新規追加：環境変数検証機能
def validate_required_env_vars():
    """必須環境変数の存在確認"""
    required_vars = [
        "AZURE_OPENAI_API_KEY",
        "AZURE_OPENAI_ENDPOINT", 
        "JWT_SECRET_KEY"
    ]
    
    missing_vars = []
    for var in required_vars:
        if not os.getenv(var):
            missing_vars.append(var)
    
    if missing_vars:
        raise ValueError(f"Missing required environment variables: {', '.join(missing_vars)}")
```

### Phase 2: .env ファイルの改善

#### 2.1 .env.example の更新
```bash
# Azure OpenAI設定
AZURE_OPENAI_API_KEY=your_azure_openai_api_key_here
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_MODEL=gpt-4
AZURE_OPENAI_VERSION=2024-02-15-preview

# JWT認証設定
JWT_SECRET_KEY=your_super_secret_jwt_key_here_change_in_production
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=30

# アプリケーション設定
APP_NAME=Meeting Minutes Generator
APP_VERSION=1.0.0
DEBUG=false
```

#### 2.2 開発用 .env ファイルの作成
```bash
# 開発環境用の安全なデフォルト値
AZURE_OPENAI_API_KEY=test_key_for_development
AZURE_OPENAI_ENDPOINT=https://test.openai.azure.com/
JWT_SECRET_KEY=development_secret_key_change_in_production
DEBUG=true
```

### Phase 3: ドキュメントの更新

#### 3.1 STARTUP_GUIDE.md の修正
- 環境変数設定手順の追加
- .envファイル作成方法の詳細化
- トラブルシューティングの更新

#### 3.2 README.md の更新
- 環境設定セクションの改善
- セキュリティ注意事項の追加

### Phase 4: 起動スクリプトの改善

#### 4.1 環境変数チェック機能の追加
```bash
# start_app.sh / start_dev.sh に追加
check_env_file() {
    if [ ! -f .env ]; then
        echo "⚠️  .env file not found!"
        echo "Please copy .env.example to .env and configure your settings:"
        echo "  cp .env.example .env"
        exit 1
    fi
}
```

## 📁 変更対象ファイル

### 修正ファイル
1. `src/config.py` - 環境変数読み取り方式に変更
2. `.env.example` - 完全な環境変数テンプレート
3. `.env` - 開発用デフォルト値
4. `STARTUP_GUIDE.md` - 環境設定手順の詳細化
5. `README.md` - 環境設定セクションの改善
6. `start_app.sh` - 環境変数チェック機能追加
7. `start_dev.sh` - 環境変数チェック機能追加

### 新規作成ファイル
1. `docs/ENVIRONMENT_SETUP.md` - 詳細な環境設定ガイド

## 🧪 テスト計画

### 1. 環境変数なしでの起動テスト
```bash
# .envファイルを一時的に削除してテスト
mv .env .env.backup
python src/main.py  # エラーメッセージの確認
```

### 2. 正常な環境変数での起動テスト
```bash
# .envファイルを復元してテスト
mv .env.backup .env
python src/main.py  # 正常起動の確認
```

### 3. 不正な環境変数での起動テスト
```bash
# 無効な値でのテスト
export AZURE_OPENAI_API_KEY=""
python src/main.py  # バリデーションエラーの確認
```

## ⚠️ 注意事項

### セキュリティ
- 実際のAPIキーは絶対にコミットしない
- .envファイルは.gitignoreに含める
- 本番環境では強力なJWT秘密鍵を使用

### 互換性
- 既存のテストコードとの互換性を保つ
- CI/CD環境での環境変数設定を確認

## 📈 期待される効果

### セキュリティ向上
- 機密情報のソースコード分離
- 環境別の適切な設定管理

### 開発効率向上
- 環境切り替えの簡素化
- 設定ミスの削減

### 運用性向上
- 本番環境での設定変更が容易
- 設定の可視性向上

## 🚀 実装順序

1. **Phase 1**: config.py の修正（環境変数必須化）
2. **Phase 2**: .env関連ファイルの整備
3. **Phase 3**: ドキュメント更新
4. **Phase 4**: 起動スクリプト改善
5. **テスト**: 全シナリオでの動作確認
6. **コミット**: 変更内容のコミット・プッシュ

---

**作成日**: 2025年7月23日  
**作成者**: Devin AI  
**対象ブランチ**: main_okawa_20250722
