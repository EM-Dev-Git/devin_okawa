# /login 404エラー修正計画書

## 問題の分析

### 現象
```
INFO:     127.0.0.1:52240 - "GET / HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/okawasora/devin_okawa-main_okawa_20250715/src/middleware/auth.py", line 21, in dispatch
    user_id = request.session.get("user_id")
              ^^^^^^^^^^^^^^^
  File "/home/okawasora/.pyenv/versions/3.12.10/lib/python3.12/site-packages/starlette/requests.py", line 148, in session
    "session" in self.scope
AssertionError: SessionMiddleware must be installed to access request.session
```

### 根本原因の特定

**主要原因: ミドルウェアの順序が間違っている**

現在の`src/main.py`のミドルウェア登録順序:
```python
app.add_middleware(SessionAuthenticationMiddleware)  # 28行目
app.add_middleware(SessionMiddleware, ...)           # 30-34行目
```

**問題点:**
1. `SessionAuthenticationMiddleware`が`SessionMiddleware`より先に実行される
2. セッション認証ミドルウェアが実行される時点で、まだセッションが利用できない
3. `request.session.get("user_id")`が失敗し、AssertionErrorが発生

### 技術的詳細

**FastAPIミドルウェアの実行順序:**
- ミドルウェアは**逆順**で実行される（最後に追加されたものが最初に実行）
- リクエスト処理: 最後に追加 → 最初に追加
- レスポンス処理: 最初に追加 → 最後に追加

**現在の実行順序（間違い）:**
1. `SessionAuthenticationMiddleware` ← セッションがまだ利用できない
2. `SessionMiddleware` ← セッションを初期化

**正しい実行順序:**
1. `SessionMiddleware` ← セッションを初期化
2. `SessionAuthenticationMiddleware` ← セッションが利用可能

## 修正方法

### 1. ミドルウェア順序の修正

**修正前 (src/main.py 28-34行目):**
```python
app.add_middleware(SessionAuthenticationMiddleware)

app.add_middleware(
    SessionMiddleware,
    secret_key=settings.session_secret_key,
    max_age=settings.session_expire_hours * 3600
)
```

**修正後:**
```python
app.add_middleware(
    SessionMiddleware,
    secret_key=settings.session_secret_key,
    max_age=settings.session_expire_hours * 3600
)

app.add_middleware(SessionAuthenticationMiddleware)
```

### 2. 検証手順

**修正後のテスト:**
1. FastAPIサーバーを起動
2. ブラウザで`http://localhost:8000`にアクセス
3. `/login`にリダイレクトされることを確認
4. ログインページが正常に表示されることを確認
5. サーバーログに500エラーが出ないことを確認

**期待される動作:**
```
INFO: 127.0.0.1:40702 - "GET / HTTP/1.1" 302 Found
INFO: 127.0.0.1:40702 - "GET /login HTTP/1.1" 200 OK
```

### 3. 追加の確認事項

- 除外パス設定が正しく動作するか
- セッション認証が正常に機能するか
- ログイン後のリダイレクトが正常に動作するか

## 影響範囲

**修正対象ファイル:**
- `src/main.py` (ミドルウェア順序の修正のみ)

**影響なし:**
- 認証ロジック
- ルーター設定
- 除外パス設定

## リスク評価

**リスク: 低**
- 単純なミドルウェア順序の修正
- 既存の認証ロジックに変更なし
- 後方互換性に影響なし

## 実装手順

1. `src/main.py`のミドルウェア順序を修正
2. サーバーを再起動
3. 認証フローをテスト
4. 修正をコミット・プッシュ
